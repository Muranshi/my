<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Echo Point å¥èº«æˆ¿ - è·‘æ­¥åŒº</title>
  <!-- å¼•å…¥ Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>
</head>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: #f7f7f7;
    margin: 0;
    padding: 0;
  }
  header {
    background-color: #222;
    color: white;
    padding: 12px;
    text-align: center;
    font-size: 16px;
  }
  #comments-container {
    padding: 16px;
    max-width: 400px;
    margin: auto;
  }
  .echo {
    background: #fff;
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .echo p {
    margin: 0 0 6px;
  }
  .like {
    color: #28a745;
    font-size: 14px;
    cursor: pointer;
  }
  .back-button {
    display: block;
    margin: 20px auto;
    padding: 10px 20px;
    background-color: #555;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    text-align: center;
    text-decoration: none;
    width: fit-content;
  }
</style>
<body>
  <!-- é¡µé¢å†…å®¹ï¼šè·‘æ­¥åŒºç•™è¨€æ¿æ ‡é¢˜å’Œå®¹å™¨ -->
  <header>ğŸ§˜ è·‘æ­¥åŒº - å›å£°è¯¦æƒ…</header>
  <div id="comments-container"></div>

  <a class="back-button" href="index.html">â¬… è¿”å›åœ°å›¾</a>
  <!-- å‰ç«¯é€»è¾‘è„šæœ¬ï¼Œç»Ÿä¸€æ”¾ç½®åœ¨é¡µé¢åº•éƒ¨ -->
  <script>
    // åˆå§‹åŒ– Firebaseï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„ Firebase é…ç½®ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyATBXxDaWTdDN8zVK-wa7PeZ6PUgCNfE7g",
      authDomain: "echo-gym-49df3.firebaseapp.com",
      projectId: "echo-gym-49df3",
      storageBucket: "echo-gym-49df3.firebasestorage.app",
      messagingSenderId: "1070598827189",
      appId: "1:1070598827189:web:8cacaa4aa1438bcdbea2fc"
    };    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // å½“å‰é¡µé¢å¯¹åº”çš„åŒºåŸŸåç§°ï¼ˆç”¨äºè¿‡æ»¤ Firestore æ•°æ®ï¼‰
    const currentArea = "è·‘æ­¥åŒº";
    
    // ä» Firestore åŠ è½½å¹¶æ¸²æŸ“å½“å‰åŒºåŸŸçš„ç•™è¨€åˆ—è¡¨
    function loadMessages() {
      db.collection("echoMessages")
        .where("area", "==", currentArea)
        .orderBy("timestamp", "desc")
        .get()
        .then(querySnapshot => {
          const container = document.getElementById("comments-container");
          container.innerHTML = "";  // æ¸…ç©ºå®¹å™¨å†…å®¹
          querySnapshot.forEach(doc => {
            const data = doc.data();
            const text = data.text || "";
            const likes = data.likes || 0;
            // å°† Firestore æ—¶é—´æˆ³è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´å­—ç¬¦ä¸²
            let timeString = "";
            if (data.timestamp) {
              let dateObj;
              if (typeof data.timestamp.toDate === "function") {
                dateObj = data.timestamp.toDate();
              } else {
                // è‹¥ timestamp å·²æ˜¯æ¯«ç§’æ•°æˆ–æ—¥æœŸå­—ç¬¦ä¸²
                dateObj = new Date(data.timestamp);
              }
              timeString = dateObj.toLocaleString();  // æœ¬åœ°æ—¶é—´æ ¼å¼
            }
            // åˆ›å»ºç•™è¨€å…ƒç´ ç»“æ„
            const commentDiv = document.createElement("div");
            commentDiv.className = "comment";
            // ç•™è¨€æ–‡æœ¬
            const textP = document.createElement("p");
            textP.className = "comment-text";
            textP.textContent = text;
            // ç•™è¨€å…ƒä¿¡æ¯ï¼ˆæ—¶é—´å’Œç‚¹èµï¼‰
            const metaP = document.createElement("p");
            metaP.className = "comment-meta";
            // æ—¶é—´ Span
            const timeSpan = document.createElement("span");
            timeSpan.className = "comment-time";
            timeSpan.textContent = `æ—¶é—´: ${timeString}`;
            // ç‚¹èµæ•° Span
            const likesSpan = document.createElement("span");
            likesSpan.className = "comment-likes";
            likesSpan.textContent = `ç‚¹èµæ•°: ${likes}`;
            // ç‚¹èµæŒ‰é’®
            const likeBtn = document.createElement("button");
            likeBtn.className = "like-btn";
            likeBtn.textContent = "ç‚¹èµ";
            // å°†æ—¶é—´ã€ç‚¹èµæ•°å’ŒæŒ‰é’®æ·»åŠ åˆ° meta æ®µè½
            metaP.appendChild(timeSpan);
            metaP.appendChild(document.createTextNode("ã€€"));  // åŠ ä¸€ä¸ªç©ºæ ¼åˆ†éš”
            metaP.appendChild(likesSpan);
            metaP.appendChild(document.createTextNode(" "));
            metaP.appendChild(likeBtn);
            // ç»„åˆæ–‡æœ¬å’Œå…ƒä¿¡æ¯åˆ°è¯„è®ºå®¹å™¨
            commentDiv.appendChild(textP);
            commentDiv.appendChild(metaP);
            container.appendChild(commentDiv);
            // ç‚¹èµæŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼šæ›´æ–°ç‚¹èµæ•°
            likeBtn.addEventListener("click", () => {
              // é˜²æ­¢é‡å¤ç‚¹å‡»ï¼Œå…ˆç¦ç”¨æŒ‰é’®
              likeBtn.disabled = true;
              // æœ¬åœ°ç•Œé¢ç‚¹èµæ•° +1
              const newLikes = likes + 1;
              likesSpan.textContent = `ç‚¹èµæ•°: ${newLikes}`;
              // æ›´æ–° Firestore ä¸­çš„ç‚¹èµæ•°å­—æ®µï¼ˆåŸå­è‡ªå¢ 1ï¼‰
              db.collection("echoMessages").doc(doc.id).update({
                likes: firebase.firestore.FieldValue.increment(1)
              }).catch(err => {
                console.error("ç‚¹èµæ›´æ–°å¤±è´¥:", err);
              });
            });
          });
        })
        .catch(error => {
          console.error("è·å–ç•™è¨€æ•°æ®å‡ºé”™:", error);
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæ¯•åæ‰§è¡ŒåŠ è½½ç•™è¨€
    document.addEventListener("DOMContentLoaded", loadMessages);
  </script>
</body>
</html>